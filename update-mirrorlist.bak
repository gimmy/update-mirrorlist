#!/bin/bash

# Test for root
if [ $EUID -ne 0 ]; then
	echo "Only root can update the mirrorlist"
	exit 1
fi

# Log
log() {
	echo "$1"
	echo `date +'[%Y-%m-%d %H:%M]'` "$1" >> /var/log/pacman.log
}

# Defaults
PROTOCOL=('http' 'ftp')
IPV=(4)
USE_STATUS=true
COUNTRIES=()

# Get config
. /etc/pacman.d/update-mirrorlist.conf

# Build uri
uri='http://www.archlinux.org/mirrorlist/?'

if $USE_STATUS; then
	uri="${uri}use_mirror_status=on&"
fi

for x in "${PROTOCOL[@]}"; do
	uri="${uri}protocol=${x}&"
done

for x in "${IPV[@]}"; do
	uri="${uri}ip_version=${x}&"
done

for x in "${COUNTRIES[@]}"; do
	uri="${uri}country=${x}&"
done

# Back up
if [ ! -e /etc/pacman.d/mirrorlist.original ]; then
	log 'Backing up original mirrorlist'
	cp /etc/pacman.d/mirrorlist /etc/pacman.d/mirrorlist.original
fi

# Update
log 'Updating mirrorlist'

if [ "`ping -c 1 archlinux.org`" ]; then
	wget -qO- "$uri" | sed 's/^#Server/Server/g' > /etc/pacman.d/mirrorlist
	log "Updated mirrorlist"
else
	log "Error: Could not reach host: archlinux.org"
	exit 1
fi

exit 0
